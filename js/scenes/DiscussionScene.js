//ã‚„ã‚‹ã“ã¨
//â‘ éšœå®³ãŒèµ·ãã¦ã„ã‚‹ã“ã¨ã¯ã‚ã‹ã‚‹ãŒãªãœèµ·ãã¦ã„ã‚‹ã‹ã‚ã‹ã‚‰ãªã„äººã®å¯¾å‡¦             7/21å®Œæˆ    
// â‡’ã€€èª°ã‹ã²ã¨ã‚Šã§ã‚‚æ­£è§£ã®æ¡ˆã«åˆ°é”ã—ã¦ã„ã‚Œã°ã€æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚ºã«é£›ã°ã™ã€ãã®ä»£ã‚ã‚Šã€ã‚ã‹ã£ã¦ã„ã‚‹äººã«éŸ³å£°åª’ä»‹ã§æƒ…å ±å…±æœ‰
//     èª°ä¸€äººã‚ã‹ã£ã¦ã„ãªã„å ´åˆã€Webä¼šè­°ã§æƒ…å ±å…±æœ‰ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ ã€€ã€€ã€€ã€€ã€€ã€€
//â‘¡ä»–ã®äººãŒéšœå®³ã‚’ç™ºè¦‹ã—ã€ãã‚ŒãŒãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã•ã‚Œã¦ã„ã‚‹ãŒã€éšœå®³ãŒã©ã“ã§èµ·ãã¦ã„ã‚‹ã‹ã‚‚ã‚ã‹ã‚‰ãªã„
// â‡’  ã“ã“ã§éšœå®³ãŒèµ·ãã¦ã„ã‚‹ã‚ˆã¨çŸ¥ã‚‰ã›ã‚‹ãƒ’ãƒ³ãƒˆæ©Ÿèƒ½çš„ãªã‚‚ã®ã‚’ä½œæˆã™ã‚‹ã€‚ã€€ã€€ã€€ã€€ã€€ã€€7/21å®Œæˆ
//â‘¢èª°ä¸€äººã€éšœå®³å†…å®¹ãŒèµ·ãã¦ã„ã‚‹ã®ã«ã€èª°ä¸€äººãã®éšœå®³ã‚’ç™ºè¦‹ã§ããšã«ã€checkãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã€‚
// â‡’ã€€éšœå®³ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã®ã§ã€æ¢ã—ã¦ãã ã•ã„çš„ãªã‚‚ã®ã‚’ä½œã‚‹ã€‚ã€€ã€€ã€€ã€€ã€€
//â‘£ã€€â‘¢ã«ã¤ã„ã¦ã¯ã€checkãƒœã‚¿ãƒ³ã‚’ä¸€å›æŠ¼ã—ãŸã¨ãã¨ã€è¤‡æ•°å›æŠ¼ã•ã‚ŒãŸæ™‚ã§ã€å†…å®¹ã‚’å¤‰æ›´ã™ã‚‹ã€‚
// â‡’  ã“ã“ã§éšœå®³ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ã¨â‘¡ã®æ©Ÿèƒ½ã¨ä¼¼ãŸã‚ˆã†ãªã‚‚ã®ã‚’ä½œã‚‹ã€‚ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€
//â‘¤éšœå®³çŠ¶æ³ã®åˆ¤å®šã«ã¯ã€æ­£è§£ã®ã‚‚ã®ã¨ç…§ã‚‰ã—åˆã‚ã›ã®æ–¹æ³•ã«å¤‰æ›´ã€€ã€€ã€€ã€€             7/16å®Œæˆ
// â‡’ã€€ã‚¿ã‚¹ã‚¯ã”ã¨ã«æ­£è§£ã®å›ç­”ã‚’ç”¨æ„ã—ã¦ãŠã„ã¦ã€ãã‚Œã¨ç…§ã‚‰ã—åˆã‚ã›ã‚‹æ–¹æ³•ã«å¤‰æ›´ã€‚
//â‘¥ã²ã¨ã‚Šã€ã²ã¨ã‚Šæ­£è§£ã‹ã©ã†ã‹ã‚’é€šã™ã€‚ã€€ã€€ã€€ã€€ã€€                                 7/16å®Œæˆã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ ã€€ã€€ã€€ã€€ã€€
//â‘¦Webä¼šè­°ã§æƒ…å ±å…±æœ‰ã—ã€ä¿®æ­£æ¡ˆã‚’ä½œæˆã—ã¦ã‹ã‚‰ã®æŠ•ç¥¨æ©Ÿèƒ½ãƒ•ã‚§ãƒ¼ã‚ºã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€   ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€
//â‘§ä¿®æ­£æ¡ˆã‚’æ±ºã‚ã‚‹éš›ã«ã€æ™‚é–“åˆ¶é™ä»˜ãã§éŸ³å£°åª’ä»‹ã«ã—ãŸæƒ…å ±å…±æœ‰ãƒ•ã‚§ãƒ¼ã‚ºã®ä½œæˆ(äº‹å‰ã«éŸ³å£°ã‚’è¡Œã£ãŸå ´åˆã¯ã€ãªã—ã§)

export class DiscussionScene extends Phaser.Scene {
    constructor() {
        super({ key: 'DiscussionScene' });
        this.timeLeft = 300; // ã‚¿ã‚¤ãƒãƒ¼ã®æ™‚é–“ï¼ˆç§’ï¼‰
        this.vote_flag = 0;  // æŠ•ç¥¨ã‚’ä¸€äººä¸€å›ã¾ã§ã«ã™ã‚‹ãŸã‚
        this.voting_flag = 0; // å…¥ã‚Œã‚Œã‚‹ç¥¨æ•°ã‚’ä¸€ã¤ã«ã™ã‚‹ãŸã‚
        this.voting_id = "null";
        this.proposal_count = 0;
        this.proposal = [];
        this.activePps = "null";
    }

    preload() {
        this.load.image('dummy-button', '../../assets/images/dummy-button.png');
        this.load.image('terminalButton', '../../assets/images/terminal-button.png');
        this.load.image('message', '../../assets/images/message2.png');
        this.load.image('backButton', '../../assets/images/BackButton.png');
    }

    //wsã¯ã€chatã‚ˆã†ã®é€šä¿¡ã‚½ã‚±ãƒƒãƒˆ
    //addChatä»¥ä¸‹ã¯ã€ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
    init(data) {
        //this.socket = data.socket;
        this.ws = data.ws;
        this.name = data.name;
        this.addChatUI = data.addChatUI; 
        this.sendMessage = data.sendMessage;
        //this.initChatSocket = data.initChatSocket;
        this.createDiv = data.createDiv;
        this.createMessage = data.createMessage;
        this.resetHTMLList = data.resetHTMLList;
        this.generateId = data.generateId;
    }

    create(data) {
        this.socket = data.socket;

        this.resetHTMLList();
        this.resetCount();

        console.log("this.socket = ", this.socket);
        console.log("this.ws = ", this.ws);

        this.createMessageWindow(); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆ

        this.createBackButotn();

        //ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
        //this.addChatUI();           //ãƒãƒ£ãƒƒãƒˆUIã‚’DOMã§è¿½åŠ 
        //this.initChatSocket();      //WebSocketã®åˆæœŸåŒ–
        this.initVoteSocket();
        this.createVoteWindow();

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
        /* this.messageText = this.add.text(this.cameras.main.centerX, this.cameras.main.centerY + 290, 'ä»¥ä¸‹ã®ä½œæ¥­ã‚’ã“ã®ã‚¿ã‚¤ãƒãƒ¼ã®æ®‹ã‚Šæ™‚é–“ã‚’ç›®å®‰ã«è¡Œã£ã¦ãã ã•ã„ï¼\
            \n â‘ ãƒ¬ãƒãƒ¼ãƒˆã‚’ã—ãŸäººãŒä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã«ã©ã®ã‚ˆã†ãªéšœå®³ãŒç™ºç”Ÿã—ãŸã‹ã‚’å£é ­ã§èª¬æ˜ã™ã‚‹ï¼\
            \n â‘¡ãƒ¬ãƒãƒ¼ãƒˆã‚’ã—ãŸäººãŒãƒ¡ãƒ³ãƒãƒ¼ã«å¯¾ã—ã¦ï¼Œå…ˆç¨‹ã®èª¬æ˜ãŒç†è§£ã§ããŸã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ï¼\
            \n â€»â‘¡ã§ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã®ç†è§£ãŒå¾—ã‚‰ã‚Œã‚‹ã¾ã§èª¬æ˜ã‚’ç¹°ã‚Šè¿”ã™ï¼\
            \n â‘¢èª¬æ˜ã‚’å—ã‘ãŸãƒ¡ãƒ³ãƒãƒ¼2äººã®ã†ã¡ã©ã¡ã‚‰ãŒéšœå®³ã®ä¿®æ­£ã‚’ã™ã‚‹ã‹æ±ºã‚ã‚‹ï¼\
            \n â‘£Backãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚Šï¼Œæ‹…å½“è€…ãŒéšœå®³ã‚’ä¿®æ­£ã™ã‚‹\
            \n\
            \nè£œè¶³ï¼šèª¬æ˜ã‚„ãã‚Œã‚’ç†è§£ã™ã‚‹ä¸Šã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’å‚ç…§ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ï¼', {
            fontSize: '24px',
            fill: '#000'
        }).setOrigin(0.5, 0.5);
        */

        this.messageText = this.add.text(this.cameras.main.centerX, this.cameras.main.centerY + 300, 'å®Ÿé¨“å®Ÿæ–½è€…ã®æŒ‡ç¤ºã«å¾“ã£ã¦ãã ã•ã„', {
            fontSize: '50px',
            fill: '#000'
        }).setOrigin(0.5, 0.5);

        // show the timer
        this.timerText = this.add.text(this.cameras.main.centerX, this.cameras.main.centerY + 50, `Time Left: 300`, {
            fontSize: '28px',
            fill: '#000'
        }).setOrigin(0.5);


        // ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        this.messageText = this.add.text(this.cameras.main.centerX, this.cameras.main.centerY, 'ãƒªãƒã‚¸ãƒˆãƒªéšœå®³å ±å‘Šã‚»ãƒƒã‚·ãƒ§ãƒ³', {
            fontSize: '32px',
            fill: '#000'
        }).setOrigin(0.5);

        
        // Decrement the timer every second
        this.timeEvent = this.time.addEvent({
            delay: 1000,
            callback: this.updateTimer,
            callbackScope: this,
            loop: true
        });

        this.createTerminalButton();
    }
    
    startTimer() {
        // 1ç§’ã”ã¨ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’æ›´æ–°ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ
        this.timeEvent = this.time.addEvent({
            delay: 1000, // 1000ãƒŸãƒªç§’ã”ã¨ã«æ›´æ–°
            callback: this.updateTimer,
            callbackScope: this,
            loop: true // ãƒ«ãƒ¼ãƒ—ã•ã›ã‚‹
        });
    }

    updateTimer() {
        if (this.timeLeft > 0) {
            this.timeLeft -= 1;
            this.timerText.setText(`Time: ${this.timeLeft}`);
        } else {
            this.timeEvent.remove();
            // this.scene.start('MainGameScene', { socket: this.socket });
        }
    }

    createTerminalButton() {
        const buttonScale = 0.5;
        const buttonWidth = this.textures.get('terminalButton').getSourceImage().width * buttonScale;
        const buttonHeight = this.textures.get('terminalButton').getSourceImage().height * buttonScale;
    
        const x = buttonWidth / 2 + 10; // å·¦ç«¯ã«é…ç½®
        const y = this.cameras.main.height - buttonHeight / 2 - 10; // ç”»é¢ä¸‹ç«¯ã«è¿‘ã„ä½ç½®
    
        this.add.image(x, y, 'terminalButton')
            .setInteractive()
            .setScale(buttonScale)
            .on('pointerdown', () => this.openTerminal());
    }

    createBackButotn() {
        const buttonScale = 0.5;
        const buttonWidth = this.textures.get('backButton').getSourceImage().width * buttonScale;
        const buttonHeight = this.textures.get('backButton').getSourceImage().height * buttonScale;

        const x = this.cameras.main.width - buttonWidth / 2 - 20;
        const y = this.cameras.main.height - buttonHeight / 2 - 10

        this.add.image(x, y, 'backButton')
            .setInteractive()
            .setScale(buttonScale)
            .on('pointerdown', () => {
                document.querySelectorAll('.solutionDiv').forEach(el => {
                    el.style.display = 'none';
                });
                if(this.votingDiv){
                    this.votingDiv.innerHTML = '';
                }
                this.scene.start('MainGameScene')
            });
    }

    openTerminal() {
        window.open('../../term.html', '_blank');
    }

    createMessageWindow() {
        this.messageWindow = this.add.image(this.cameras.main.centerX, this.cameras.main.centerY + 300, 'message')
            .setInteractive()
            .setScale(0.4)
    }

    createVoteWindow(){
        // ãƒãƒ£ãƒƒãƒˆUIç”¨ã®DOMè¦ç´ ã‚’è¿½åŠ ï¼ˆCSSã¯å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
        const voteHTML =` 
        <div id="voteBox" style=" position: absolute; top: 100px; right: 10px;
         z-index: 1000;  /* â† è¿½åŠ : ã“ã‚Œã§Phaserã‚ˆã‚Šå‰ã«å‡ºã‚‹ */
         width: 300px; background: rgba(0,0,0,0.5); color: white;
         padding: 10px; font-size: 14px;">
            <div class="title">æŠ•ç¥¨</div>
            <div calss="contents scroll" id="vote">
            <div calss="contents input">
                <div>
                    <input class="msg" type="text" id="msgInput" placeholder="message" />
                </div>
                 <button id="chatSendBtn"()">Send</button>
                 <button id="voteSendBtn"()">Vote</button>
                 <button id="cancelBtn"()">Cancel</button>
            </div>
            </div>
        </div>
        `;

        MainHTMLList.innerHTML = voteHTML;
        document.body.appendChild(MainHTMLList);

        const chatSendBtn = document.getElementById("chatSendBtn");
        if (chatSendBtn) {
            chatSendBtn.addEventListener("click", this.sendMessage.bind(this));
        } else {
            console.warn("chatSendBtn ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
        }

        const voteSendBtn = document.getElementById("voteSendBtn");
        if (voteSendBtn) {
            voteSendBtn.addEventListener("click", this.voteMessage.bind(this));
        } else {
            console.warn("chatSendBtn ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
        }

        const cancelBtn = document.getElementById("cancelBtn");
        if (cancelBtn) {
            cancelBtn.addEventListener("click", this.cancelVote.bind(this));
        } else {
            console.warn("chatSendBtn ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
        }
    }

    voteMessage() {
        const now = new Date();
        const json = {
            id: this.generateId(),
            type: "vote",
            name: this.name,
            message: document.getElementById('msgInput').value,
            time: `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`,
            voteCount: 0
        };

        //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        if(!this.vote_flag){
            console.log("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡");
            this.ws.send(JSON.stringify(json));  
            document.getElementById('msgInput').value = '';
            this.vote_flag = 1;
            this.activePps = json.id;
        }else{
            console.log("ç™ºè¡¨æ¸ˆã¿");
        }
    }

    cancelVote(){
        if(this.vote_flag === 1){
            this.vote_flag = 0;
            
            const json = {
                type: "voteCancel",
                activePps: this.activePps        
            };

            console.log("ã‚­ãƒ£ãƒ³ã‚»ãƒ«");
            this.ws.send(JSON.stringify(json));  
        }else{
            console.log("æœªç™ºè¡¨");
        }
    }

    initVoteSocket(){
        let uuid = null;
        //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡å‡¦ç†
        this.ws.onmessage = (event) => {
            const json = JSON.parse(event.data);
            console.log("json = " + json);
            const voteDiv = document.getElementById('vote');

            switch (json.type) {
                case "chat":
                    console.log("Discuss");
                    //const chatDiv = document.getElementById('chat');
                    voteDiv.appendChild(this.createMessage(json));
                    voteDiv.scrollTo(0, voteDiv.scrollHeight);
                    break;

                case "vote":
                case "voteCancel":
                    if(json.type === "vote"){
                        this.proposal_count++;
                        this.proposal.push(json);
                    }

                    if(json.type === "voteCancel"){
                        this.proposal_count--;
                        const index = this.proposal.findIndex(m => m.id === json.id);
                        if (index !== -1) {
                          this.proposal.splice(index, 1); // ç‰¹å®šã®è¦ç´ ã‚’å‰Šé™¤
                        }
                    }
                    
                    if(this.proposal_count % 3 !== 0){
                        const proposalHTML = `
                        <div id="someoneProposal" style="display: none;position: fixed;top: 20%;left: 50%;
                            transform: translate(-50%, -50%);z-index: 9999;background: rgba(0, 0, 0, 0.85);
                            color: white;padding: 30px 50px;font-size: 16px;border-radius: 10px;
                            box-shadow: 0 0 20px rgba(0,0,0,0.5);text-align: center;">
                        </div>
                        `;

                        // è¦ç´ ä½œæˆã¨è¿½åŠ 
                        const wrapper = document.createElement('div');
                        wrapper.innerHTML = proposalHTML;
                        document.body.appendChild(wrapper);

                        this.proposalDiv = document.getElementById('someoneProposal');

                        this.proposalDiv.innerHTML = `ğŸ’¡ã€Œ${this.proposal_count % 3}äººãŒä¿®æ­£æ¡ˆã‚’å‡ºã—ã¾ã—ãŸã€<br>
                                                        æŠ•ç¥¨é–‹å§‹ã¾ã§å¾Œ${3 - this.proposal_count % 3}äºº`;
                        this.proposalDiv.style.display = 'block';

                    }else{
                        this.proposalDiv.style.display = 'none';
                        const votingHTML = `
                        <div id="voting" style="display: none;position: fixed;top: 50%;left: 50%;
                            transform: translate(-50%, -50%);z-index: 9999;background: rgba(0, 0, 0, 0.85);
                            color: white;padding: 30px 50px;font-size: 16px;border-radius: 10px;
                            box-shadow: 0 0 20px rgba(0,0,0,0.5);text-align: center;">
                            <div class="title">æŠ•ç¥¨</div>
                            <div calss="contents scroll" id="voting">
                        </div>
                        `;
                        const wrapper = document.createElement('div');
                        wrapper.innerHTML = votingHTML;
                        document.body.appendChild(wrapper);

                        this.votingDiv = document.getElementById('voting');
                        console.log("proposal_count = " + this.proposal_count);
                        for(let i = this.proposal_count - 3; i < this.proposal_count; i++){
                            console.log("i = " + i);
                            console.log(this.proposal[i].message);
                            console.log("æŠ•ç¥¨ä¸­");
                            this.votingDiv.appendChild(this.createVote(this.proposal[i]));
                            this.votingDiv.scrollTo(0,this.votingDiv.scrollHeight);
                        }
                        this.votingDiv.style.display = 'block';
                    }
                    break;

                case "uuid":
                    uuid = join.uuid;
                    break;
                
                case "goodclick":
                    // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’æ¢ã™
                    const targetElement = document.querySelector(`[data-id="${json.targetMessageId}"]`);
                    if (targetElement) {
                        // voteCountã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ span ã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆclassãªã©ã§ç‰¹å®šã™ã‚‹ã¨å®‰å…¨ï¼‰
                        const voteCountSpan = targetElement.querySelector('.vote-count');
                        if (voteCountSpan) {
                            voteCountSpan.textContent = json.voteCount.toString();
                        }
                    } else {
                        // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€æ–°è¦æç”»ã™ã‚‹ï¼ˆä»»æ„ï¼‰
                        chatDiv.appendChild(this.createVote(json));
                    }
                    //ä¸‰ç¥¨å…¥ã‚Œã‚‰ã‚Œã‚‹ã¨ã€è§£æ±ºæ–¹æ³•ãŒã§ã‹ã§ã‹è¡¨ç¤º
                    if (json.voteCount === 3) {
                        this.votingDiv.style.display = 'none';
                        const name = targetElement.querySelector('.name')?.textContent || '(no name)';
                        const message = targetElement.querySelector('.message')?.textContent || '(no message)';
                        console.log("ğŸŒŸ è§£æ±ºæ–¹æ³•ï¼š");
                        console.log("name =", name);
                        console.log("message =", message);

                        const solutionHTML = `
                        <div id="voteSolution" style="
                            display: none;
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            z-index: 9999;
                            background: rgba(0, 0, 0, 0.85);
                            color: white;
                            padding: 30px 50px;
                            font-size: 20px;
                            border-radius: 10px;
                            box-shadow: 0 0 20px rgba(0,0,0,0.5);
                            text-align: center;
                        ">
                        </div>
                        `;

                        // è¦ç´ ä½œæˆã¨è¿½åŠ 
                        const wrapper = document.createElement('div');
                        wrapper.innerHTML = solutionHTML;
                        document.body.appendChild(wrapper);

                        const solutionDiv = document.getElementById('voteSolution');

                        solutionDiv.innerHTML = `ğŸ’¡ã€Œ${name}ã€ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé¸ã°ã‚Œã¾ã—ãŸï¼<br>${message}<br><br>
                                                ã“ã®ä¿®æ­£ã‚’ã™ã‚‹Playerã¯ã€ã€Œ${json.taskName}ã€`;
                        

                        solutionDiv.style.display = 'block';

                        solutionDiv.className = 'solutionDiv';

                        //MainHTMLList.innerHTML = solutionHTML;
                        //document.body.appendChild(MainHTMLList);
                        //solutionDiv.appendChild(this.createSMsg(name, message));
                        //solutionDiv.scrollTo(0, solutionDiv.scrollHeight);

                        //banner.textContent = `ğŸ’¡ ã€Œ${name}ã€ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé¸ã°ã‚Œã¾ã—ãŸï¼\n"${message}"`;

                        //5ç§’å¾Œã«MainSecenã«ç§»å‹•
                        setTimeout(() => {
                            //wrapper.remove(); // or solutionDiv.style.display = 'none';
                            document.querySelectorAll('.solutionDiv').forEach(el => {
                                el.style.display = 'none';
                            });
                            if(this.votingDiv){
                                this.votingDiv.innerHTML = '';
                            }
                            this.solutionHTML2 = `
                                <div id="someoneClickReport" style="
                                    display: none;
                                    position: fixed;
                                    top: 20%;
                                    left: 50%;
                                    transform: translate(-50%, -50%);
                                    z-index: 9999;
                                    background: rgba(0, 0, 0, 0.85);
                                    color: white;
                                    padding: 30px 50px;
                                    font-size: 16px;
                                    border-radius: 10px;
                                    box-shadow: 0 0 20px rgba(0,0,0,0.5);
                                    text-align: center;
                                ">
                                </div>
                        `;

                        wrapper.innerHTML = this.solutionHTML2;
                        document.body.appendChild(wrapper);

                        this.solutionDiv2 = document.getElementById('someoneClickReport');

                        this.solutionDiv2.innerHTML = `ä¿®æ­£æ–¹æ³•ã¯ã€${message}<br>
                                                    ä¿®æ­£è€…ã¯ã€${json.taskName}`;
                        this.solutionDiv2.style.display = 'block';

                        this.scene.start('MainGameScene',{
                            socket : this.socket,
                            ws : this.ws,
                            name : this.name,
                            solutionDiv2: this.solutionDiv2
                        })
                        }, 5000);
                    }
                    break;
            }
        };
    }

    createSMsg(name, message){
        const side = 'mine';
        const sideElement = this.createDiv(side);
        const nameElement = this.createDiv('name');
        const textElement = this.createDiv('text');
        const sideTextElement = this.createDiv(`${side}-text`);

        nameElement.textContent = name;
        textElement.textContent = message;

        sideElement.appendChild(sideTextElement);
        sideTextElement.appendChild(nameElement);
        sideTextElement.appendChild(textElement); 

        return sideElement;
    }

    createVote(json) {
        const side = json.mine ? 'mine' : 'other';
        const sideElement = this.createDiv(side);
        const sideTextElement = this.createDiv(`${side}-text`);
        const idElement = this.createDiv('id');
        const timeElement = this.createDiv('time');
        const nameElement = this.createDiv('name');
        const textElement = this.createDiv('text');

        idElement.textContent = json.id;
        timeElement.textContent = json.time;
        nameElement.textContent = json.name;
        nameElement.className = 'name';
        textElement.textContent = json.message;
        textElement.className = 'message';

        // æŠ•ç¥¨ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢
        const voteContainer = this.createDiv('vote-container');
        const voteButton = document.createElement('button');
        voteButton.textContent = 'ğŸ‘';
        voteButton.style.marginLeft = '10px';

        const voteCount = document.createElement('span');
        voteCount.textContent = '0';
        voteCount.className = 'vote-count';
        voteCount.style.marginLeft = '5px';
        
        // ã‚¯ãƒªãƒƒã‚¯æ™‚ã«æŠ•ç¥¨æ•°+1
        voteButton.addEventListener('click', () => {
            if(!this.voting_flag){   //ã¾ã æŠ•ç¥¨ã—ã¦ãªã„
                    const voteMessage = {
                    type: "goodclickOn",
                    targetMessageId: json.id,  // â† ã©ã®ãƒãƒ£ãƒƒãƒˆã«å¯¾ã™ã‚‹æŠ•ç¥¨ã‹
                    };
                this.ws.send(JSON.stringify(voteMessage));
                this.voting_flag = 1;
                this.voting_id = json.id;
            }else if(this.voting_id === json.id){    //æŠ•ç¥¨ã—ãŸã®ã‚’å–ã‚Šæ¶ˆã™å ´åˆ
                 const voteMessage = {
                    type: "goodclickOff",
                    targetMessageId: json.id,  // â† ã©ã®ãƒãƒ£ãƒƒãƒˆã«å¯¾ã™ã‚‹æŠ•ç¥¨ã‚’å–ã‚Šæ¶ˆã™ã‹
                    };
                this.ws.send(JSON.stringify(voteMessage));
                this.voting_flag = 0;
                this.voting_id = "null";
            }else{   //è¤‡æ•°æŠ•ç¥¨ã™ã‚‹å ´åˆ
                console.log("æŠ•ç¥¨æ¸ˆã¿");
            }
        });

        voteContainer.appendChild(voteButton);
        voteContainer.appendChild(voteCount);

        sideElement.setAttribute('data-id', json.id);
        sideElement.appendChild(sideTextElement);
        sideTextElement.appendChild(timeElement);
        sideTextElement.appendChild(nameElement);
        sideTextElement.appendChild(textElement);
        sideTextElement.appendChild(voteContainer); 

        return sideElement;
    }

    resetCount(){
        this.vote_flag = 0;
        this.voting_flag = 0;
        this.voting_id = "null";
        this.activePps = "null";
    }
}